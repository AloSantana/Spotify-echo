name: 'Budget Check'
description: 'Check Perplexity API budget status before proceeding'
outputs:
  can_proceed:
    description: 'Whether the workflow can proceed based on budget'
    value: ${{ steps.check.outputs.can_proceed }}
  budget_state:
    description: 'Current budget state (OK, WARNING, HARD_STOP)'
    value: ${{ steps.check.outputs.state }}
  usage_percentage:
    description: 'Budget usage percentage'
    value: ${{ steps.check.outputs.usage }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python Dependencies
      shell: bash
      run: pip install pyyaml
    
    - name: Check Budget Status
      id: check
      shell: bash
      run: |
        echo "ðŸ’° Checking Perplexity API budget..."
        
        # Try to get budget status
        if python3 scripts/perplexity_costs.py budget > budget.json 2>&1; then
          # Parse the budget data with proper error handling
          CAN_PROCEED=$(python3 -c "import json; print(json.load(open('budget.json'))['can_proceed'])" 2>/dev/null || echo "false")
          STATE=$(python3 -c "import json; print(json.load(open('budget.json'))['state'])" 2>/dev/null || echo "UNKNOWN")
          USAGE=$(python3 -c "import json; print(json.load(open('budget.json'))['usage_percentage'])" 2>/dev/null || echo "100")
          
          echo "can_proceed=$CAN_PROCEED" >> $GITHUB_OUTPUT
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "usage=$USAGE" >> $GITHUB_OUTPUT
          
          echo "  State: $STATE"
          echo "  Usage: $USAGE%"
          echo "  Can Proceed: $CAN_PROCEED"
          
          if [ "$CAN_PROCEED" != "true" ]; then
            echo "âš ï¸ WARNING: Budget limit reached - workflows will run in limited/degraded mode"
          fi
        else
          # Budget check failed - be conservative and block by default
          echo "âŒ Budget check failed - blocking API usage for safety"
          echo "can_proceed=false" >> $GITHUB_OUTPUT
          echo "state=ERROR" >> $GITHUB_OUTPUT
          echo "usage=100" >> $GITHUB_OUTPUT
        fi
