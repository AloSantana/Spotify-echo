name: 'Test and Validation Framework'

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test execution mode'
        required: false
        default: 'core'
        type: choice
        options:
          - core
          - full
          - visual-only
      enforce_thresholds:
        description: 'Enforce performance thresholds'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  ENFORCE_PERF_THRESHOLDS: ${{ github.event.inputs.enforce_thresholds || 'false' }}

jobs:
  # Environment validation and setup
  validate-environment:
    runs-on: ubuntu-latest
    outputs:
      env-valid: ${{ steps.env-check.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate environment configuration
        id: env-check
        run: |
          echo "MONGODB_URI=${{ secrets.MONGODB_URI || 'mongodb://localhost:27017/echotune_test' }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET || 'test-jwt-secret-change-in-production' }}" >> .env
          echo "SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID || 'test-spotify-client-id' }}" >> .env
          echo "SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET || 'test-spotify-client-secret' }}" >> .env
          echo "NODE_ENV=test" >> .env
          
          if node scripts/env-validate.js; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Route discovery and test planning
  plan-tests:
    runs-on: ubuntu-latest
    needs: validate-environment
    if: needs.validate-environment.outputs.env-valid == 'true'
    outputs:
      test-matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate route manifest
        run: npm run test:plan
        continue-on-error: true

      - name: Build test matrix
        id: build-matrix
        run: |
          # Set simulated changes for testing in CI
          export SIMULATED_CHANGES="src/api,src/chat,package.json"
          
          if node scripts/build-test-matrix.js; then
            MATRIX=$(cat reports/test-matrix.json | jq -c '.testMatrix')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          else
            # Fallback matrix
            echo "matrix={\"unit\":{\"selected\":true},\"integration\":{\"selected\":true}}" >> $GITHUB_OUTPUT
          fi

      - name: Upload planning artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-planning
          path: |
            reports/route-manifest.json
            reports/test-matrix.json

  # Core testing (unit + integration)
  test-core:
    runs-on: ubuntu-latest
    needs: [validate-environment, plan-tests]
    if: needs.validate-environment.outputs.env-valid == 'true'
    strategy:
      matrix:
        test-type: [unit, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          echo "MONGODB_URI=mongodb://localhost:27017/echotune_test" >> .env
          echo "JWT_SECRET=test-jwt-secret-change-in-production" >> .env
          echo "SPOTIFY_CLIENT_ID=test-spotify-client-id" >> .env
          echo "SPOTIFY_CLIENT_SECRET=test-spotify-client-secret" >> .env
          echo "NODE_ENV=test" >> .env

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '6.0'

      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            coverage/
            reports/

  # E2E and Visual testing
  test-e2e-visual:
    runs-on: ubuntu-latest
    needs: [validate-environment, plan-tests]
    if: |
      needs.validate-environment.outputs.env-valid == 'true' && 
      (github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'visual-only' || 
       contains(needs.plan-tests.outputs.test-matrix, '"e2e":{"selected":true}') ||
       contains(needs.plan-tests.outputs.test-matrix, '"visual":{"selected":true}'))
    strategy:
      matrix:
        browser: [chromium, firefox]
        include:
          - browser: chromium
            visual: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Setup test environment
        run: |
          echo "MONGODB_URI=mongodb://localhost:27017/echotune_test" >> .env
          echo "JWT_SECRET=test-jwt-secret-change-in-production" >> .env
          echo "SPOTIFY_CLIENT_ID=test-spotify-client-id" >> .env
          echo "SPOTIFY_CLIENT_SECRET=test-spotify-client-secret" >> .env
          echo "NODE_ENV=test" >> .env
          echo "BASE_URL=http://localhost:3000" >> .env

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '6.0'

      - name: Start application
        run: |
          npm start &
          sleep 10
          curl -f http://localhost:3000/health || echo "Health check failed"
        timeout-minutes: 2

      - name: Run E2E tests
        run: npx playwright test tests/e2e --project=${{ matrix.browser }}
        continue-on-error: true

      - name: Run Visual tests
        if: matrix.visual
        run: npx playwright test tests/visual --project=visual-regression
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
            artifacts/
            reports/

  # Performance testing
  test-performance:
    runs-on: ubuntu-latest
    needs: [validate-environment, plan-tests]
    if: |
      needs.validate-environment.outputs.env-valid == 'true' && 
      (github.event.inputs.test_mode == 'full' || 
       contains(needs.plan-tests.outputs.test-matrix, '"performance":{"selected":true}'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Setup test environment
        run: |
          echo "MONGODB_URI=mongodb://localhost:27017/echotune_test" >> .env
          echo "JWT_SECRET=test-jwt-secret-change-in-production" >> .env
          echo "SPOTIFY_CLIENT_ID=test-spotify-client-id" >> .env
          echo "SPOTIFY_CLIENT_SECRET=test-spotify-client-secret" >> .env
          echo "NODE_ENV=test" >> .env
          echo "ENFORCE_PERF_THRESHOLDS=${{ env.ENFORCE_PERF_THRESHOLDS }}" >> .env

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '6.0'

      - name: Start application
        run: |
          npm start &
          sleep 10
          curl -f http://localhost:3000/health || echo "Health check failed"
        timeout-minutes: 2

      - name: Run performance tests
        run: npm run test:perf
        continue-on-error: true

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: |
            reports/perf-*.json
            artifacts/

  # MCP health check
  mcp-health:
    runs-on: ubuntu-latest
    needs: validate-environment
    if: needs.validate-environment.outputs.env-valid == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run MCP health check
        run: |
          # Run existing MCP validation
          npm run mcp:validate-comprehensive || echo "MCP validation completed with warnings"
        continue-on-error: true

      - name: Upload MCP results
        uses: actions/upload-artifact@v4
        with:
          name: mcp-health
          path: |
            reports/mcp-*.md
            reports/mcp-*.json

  # Collect and report results
  collect-results:
    runs-on: ubuntu-latest
    needs: [test-core, test-e2e-visual, test-performance, mcp-health]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge test results
        run: |
          # Copy artifacts to reports directory
          mkdir -p reports/
          find artifacts/ -name "*.json" -exec cp {} reports/ \;
          find artifacts/ -name "*.md" -exec cp {} reports/ \;
          
          # Generate consolidated report
          npm run test:report || echo "Report generation completed with warnings"

      - name: Display test summary
        run: |
          if [ -f reports/test-run-report.md ]; then
            echo "## üìä Test Run Summary" >> $GITHUB_STEP_SUMMARY
            cat reports/test-run-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload final reports
        uses: actions/upload-artifact@v4
        with:
          name: final-test-reports
          path: |
            reports/
            artifacts/

      - name: Check quality gates
        id: quality-gates
        run: |
          FAILED=false
          
          # Check if critical tests failed
          if [ -f reports/test-run-report.json ]; then
            TEST_PASS_RATE=$(jq -r '.metrics.testsPassedPercent // 0' reports/test-run-report.json)
            if [ "$TEST_PASS_RATE" -lt 90 ]; then
              echo "‚ùå Test pass rate below 90%: $TEST_PASS_RATE%"
              FAILED=true
            fi
            
            ENV_ERRORS=$(jq -r '.metrics.envSecretsMissingCount // 0' reports/test-run-report.json)
            if [ "$ENV_ERRORS" -gt 0 ]; then
              echo "‚ùå Environment validation errors: $ENV_ERRORS"
              FAILED=true
            fi
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ All quality gates passed"
          fi

  # Notification and status
  notify-results:
    runs-on: ubuntu-latest
    needs: [collect-results]
    if: always()
    steps:
      - name: Post status comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.collect-results.result }}';
            const mode = '${{ github.event.inputs.test_mode || "auto" }}';
            
            const body = status === 'success' 
              ? `‚úÖ **Test & Validation Framework** - All checks passed!\n\n**Mode:** ${mode}\n**Artifacts:** Available in workflow summary`
              : `‚ùå **Test & Validation Framework** - Some checks failed\n\n**Mode:** ${mode}\n**Status:** ${status}\n\nCheck workflow logs for details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });