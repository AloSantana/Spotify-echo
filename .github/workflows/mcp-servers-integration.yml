name: MCP Servers Integration

on:
  workflow_dispatch:
    inputs:
      servers:
        description: 'Comma-separated list of servers to run'
        required: false
        default: 'filesystem,memory,sequential-thinking,github-repos-manager,brave-search,perplexity-mcp,code-sandbox,screenshot-website'
      operation:
        description: 'Operation to perform'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate
          - start
          - test
          - health-check

jobs:
  mcp-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git for CI
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: |
          npm ci
          # Install dependencies from either mcp-servers or mcp-server directory
          if [ -d "mcp-servers" ] && [ -f "mcp-servers/package.json" ]; then
            echo "Installing dependencies from mcp-servers/"
            cd mcp-servers && npm ci
          elif [ -d "mcp-server" ] && [ -f "mcp-server/package.json" ]; then
            echo "Installing dependencies from mcp-server/"
            cd mcp-server && npm ci
          else
            echo "No MCP directory found with package.json"
          fi
          
      - name: Build MCP Servers
        run: |
          # Build sequential-thinking server if present
          if [ -d "mcp-servers/sequential-thinking" ]; then
            echo "Building sequential-thinking from mcp-servers/"
            cd mcp-servers/sequential-thinking && npm install && npm run build
          elif [ -d "mcp-server/sequential-thinking" ]; then
            echo "Building sequential-thinking from mcp-server/"
            cd mcp-server/sequential-thinking && npm install && npm run build
          else
            echo "sequential-thinking not found, skipping build"
          fi
          
      - name: Test Filesystem MCP Server
        if: contains(github.event.inputs.servers, 'filesystem')
        run: node validate-all-mcp-servers.js

      - name: Test Memory MCP Server
        if: contains(github.event.inputs.servers, 'memory')
        run: node validate-all-mcp-servers.js

      - name: Test Sequential Thinking Server
        if: contains(github.event.inputs.servers, 'sequential-thinking')
        run: node validate-all-mcp-servers.js


      - name: Test GitHub Repos Manager MCP
        if: contains(github.event.inputs.servers, 'github-repos-manager')
        run: node validate-all-mcp-servers.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}

      - name: Test Brave Search MCP
        if: contains(github.event.inputs.servers, 'brave-search')
        run: node validate-all-mcp-servers.js
        env:
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}

      - name: Test Perplexity MCP Server
        if: contains(github.event.inputs.servers, 'perplexity-mcp')
        run: node validate-all-mcp-servers.js
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}

      - name: Test Code Sandbox Server
        if: contains(github.event.inputs.servers, 'code-sandbox')
        run: node validate-all-mcp-servers.js

      - name: Test Screenshot Website Server
        if: contains(github.event.inputs.servers, 'screenshot-website')
        run: node scripts/mcp-manager.js health
        env:
          BROWSERBASE_API_KEY: ${{ secrets.BROWSERBASE_API_KEY }}
          BROWSERBASE_PROJECT_ID: ${{ secrets.BROWSERBASE_PROJECT_ID }}

      - name: Run MCP Health Check
        run: node scripts/mcp-manager.js health

      - name: Generate MCP Status Report
        run: |
          node scripts/mcp-manager.js report > mcp-status.txt
          cat mcp-status.txt
          
      - name: Upload MCP Reports
        uses: actions/upload-artifact@v4
        with:
          name: mcp-validation-reports
          path: |
            mcp-servers-validation-report.json
            MCP_SERVERS_VALIDATION_REPORT.md
            mcp-status.txt

  startup-integration:
    runs-on: ubuntu-latest
    needs: mcp-integration
    if: github.event.inputs.operation == 'start'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Start MCP Orchestrator
        run: |
          timeout 30s npm run mcp-orchestrator || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          
      - name: Test MCP Server Connectivity
        run: |
          # Test individual servers
          timeout 10s npm run mcp:filesystem || echo "Filesystem MCP Server test completed"
          timeout 10s npm run mcp:memory || echo "Memory MCP Server test completed"
          timeout 10s npm run mcp:sequential-thinking || echo "Sequential Thinking Server test completed"
          timeout 10s npm run mcp:github-repos-manager || echo "GitHub Repos Manager MCP test completed"
          timeout 10s npm run mcp:brave-search || echo "Brave Search MCP test completed"
          timeout 10s npm run mcp:perplexity-mcp || echo "Perplexity MCP Server test completed"
          timeout 10s npm run mcp:code-sandbox || echo "Code Sandbox Server test completed"
