name: AWS Bedrock Live Validation

on:
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip validation (for testing workflow only)'
        required: false
        default: 'false'
  push:
    branches:
      - 'copilot/fix-*'
  pull_request:
    branches:
      - main
    paths:
      - 'src/infra/BedrockInferenceProvider.js'
      - 'scripts/validate-bedrock-live.js'

jobs:
  validate-bedrock:
    name: Validate AWS Bedrock Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run AWS Bedrock Live Validation
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          echo "ðŸš€ Starting AWS Bedrock Live Validation"
          echo "================================================"
          echo "âš ï¸  This will make actual AWS API calls and incur charges!"
          echo "================================================"
          echo ""
          echo "Checking for AWS credentials..."
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID is not set!"
            echo "Please ensure secrets are configured in repository settings"
            exit 1
          else
            echo "âœ… AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:4}...${AWS_ACCESS_KEY_ID: -4}"
          fi
          
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY is not set!"
            exit 1
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY: ***${AWS_SECRET_ACCESS_KEY: -4}"
          fi
          
          echo "âœ… AWS_REGION: $AWS_REGION"
          echo ""
          
          if [ "${{ github.event.inputs.skip_validation }}" = "true" ]; then
            echo "â­ï¸  Skipping validation (skip_validation=true)"
            exit 0
          fi
          
          echo "Running validation script..."
          node scripts/validate-bedrock-live.js || {
            echo "âŒ Validation script failed with exit code $?"
            echo "Check the logs above for error details"
            exit 1
          }
          
          echo ""
          echo "âœ… Validation completed successfully!"
          echo ""
          echo "ðŸ“Š Generating evidence report..."
          node scripts/generate-bedrock-evidence.js > reports/bedrock-evidence.md || echo "âš ï¸ Evidence generation failed"
          echo "âœ… Evidence report generated"
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bedrock-validation-report
          path: |
            reports/bedrock-validation-report.json
            reports/bedrock-validation-report.md
            reports/bedrock-evidence.md
          retention-days: 30
      
      - name: Comment on PR with results
        if: github.event_name == 'push' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'reports', 'bedrock-validation-report.json');
              
              if (!fs.existsSync(reportPath)) {
                console.log('No validation report found');
                return;
              }
              
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              let comment = '## ðŸš€ AWS Bedrock Live Validation Results\n\n';
              comment += `**Timestamp:** ${report.timestamp}\n`;
              comment += `**Region:** ${report.region}\n`;
              comment += `**Provider:** AWS Bedrock (provider=bedrock)\n`;
              comment += `**Credentials Found:** ${report.credentialsFound ? 'âœ…' : 'âŒ'}\n\n`;
              
              comment += '### ðŸ¤– Models Tested\n\n';
              report.models.forEach(model => {
                if (model.success) {
                  comment += `âœ… **${model.displayName}**\n`;
                  comment += `- Model ID: \`${model.actualModelId}\`\n`;
                  if (model.requiresInferenceProfile) {
                    comment += `- Inference Profile ARN: \`${model.inferenceProfileArn}\`\n`;
                    comment += `- Cross-Region Access: Enabled\n`;
                  }
                  comment += `- Region: ${model.region}\n`;
                  comment += `- Latency: ${model.latency}ms\n`;
                  comment += `- Tokens: ${model.usage.input_tokens} input + ${model.usage.output_tokens} output\n`;
                  comment += `- Cost: $${model.cost.toFixed(6)} USD\n`;
                  comment += `- Request Timestamp: ${model.requestTimestamp}\n`;
                  comment += `- Response Timestamp: ${model.responseTimestamp}\n`;
                  comment += `- HTTP Status: ${model.httpStatus}\n`;
                  comment += `- Response: "${model.response.substring(0, 100)}..."\n\n`;
                } else {
                  comment += `âŒ **${model.displayName}**: ${model.error}\n`;
                  comment += `- HTTP Status: ${model.httpStatus || 'N/A'}\n\n`;
                }
              });
              
              comment += `### ðŸ’° Total Cost: $${report.totalCost.toFixed(6)} USD\n\n`;
              
              if (report.errors.length > 0) {
                comment += '### âš ï¸ Errors\n\n';
                report.errors.forEach(error => {
                  comment += `- ${error}\n`;
                });
                comment += '\n';
              }
              
              comment += '### ðŸ“Š Verification Steps\n\n';
              comment += '**CloudWatch Logs:**\n';
              comment += '1. Navigate to CloudWatch > Logs > `/aws/bedrock/modelinvocations`\n';
              comment += '2. Filter by timestamps in the report above\n\n';
              
              comment += '**Cost Explorer:**\n';
              comment += '1. Navigate to AWS Cost Explorer\n';
              comment += '2. Set time range: Last 24 hours\n';
              comment += '3. Filter by Service: Amazon Bedrock\n';
              comment += '4. Verify charges match expected costs\n\n';
              
              comment += '**CloudWatch Metrics:**\n';
              report.models.forEach(model => {
                if (model.success && model.requiresInferenceProfile) {
                  comment += `- ${model.displayName}: \`${model.inferenceProfileArn}\`\n`;
                }
              });
              comment += '\n';
              
              comment += 'ðŸ“Ž **Evidence Report:** Check workflow artifacts for detailed evidence\n\n';
              comment += 'âœ… **No Vertex AI paths used** - All validation via provider=bedrock\n';
              
              // Find PR number from commit
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha
              });
              
              if (prs.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prs[0].number,
                  body: comment
                });
              }
            } catch (error) {
              console.error('Error posting comment:', error);
            }
